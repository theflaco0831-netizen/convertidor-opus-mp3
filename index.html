<script>
const form = document.getElementById('form');
const bar = document.getElementById('progress-bar');
const percent = document.getElementById('percent');
const status = document.getElementById('status');

form.addEventListener('submit', async e => {
    e.preventDefault();

    status.textContent = 'Convirtiendo…';
    bar.style.width = '0%';
    percent.textContent = '0%';

    const formData = new FormData(form);
    const res = await fetch('/convert', { method: 'POST', body: formData });
    const { jobId } = await res.json();

    const interval = setInterval(async () => {
        const r = await fetch('/progress/' + jobId);
        const p = await r.json();

        bar.style.width = p.progress + '%';
        percent.textContent = p.progress + '%';

        if (p.progress >= 100) {
            clearInterval(interval);
            status.textContent = 'Descargando…';
            window.location = '/download/' + jobId;
        }
    }, 500);
});
</script>